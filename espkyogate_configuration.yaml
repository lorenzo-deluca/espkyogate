# espkyogate - ESPHome component for Bentel KYO alarms (https://github.com/lorenzo-deluca/espkyogate)
# Copyright (C) 2025 Lorenzo De Luca (me@lorenzodeluca.dev)
# Copyright (C) 2026 Rui Marinho (ruipmarinho@gmail.com)
# Example YAML for all Bentel KYO models (KYO4/8/8G/8W/32/32G)

external_components:
  - source: github://lorenzo-deluca/espkyogate
    components: [bentel_kyo]

#
# Depending of board type
#

# (for esp8266)
#esp8266:
#  board: d1_mini

# (for ESP32)
esp32:
  board: esp32dev
  framework:
    type: esp-idf
    version: recommended
  variant: esp32
  flash_size: 4MB

#
# END Board type
#

esphome:
  name: espkyogate
  friendly_name: Alarm
  comment: Alarm System Serial to HA controller
  platformio_options:
    board_build.f_cpu: 240000000L
    build_flags:
      - -O2
      - -DCORE_DEBUG_LEVEL=0

uart:
  id: uart_bus
  tx_pin: GPIO5
  rx_pin: GPIO4
  # ESP32 boards alternative directives
  # tx_pin: GPIO17
  # rx_pin: GPIO16
  baud_rate: 9600
  data_bits: 8
  parity: EVEN

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: none

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: !secret hotspot_wifi_ssid
    password: !secret hotspot_wifi_password

captive_portal:

# Enable logging
logger:
  level: INFO
  baud_rate: 0
  logs:
    component: ERROR

# Enable Home Assistant API
api:
  reboot_timeout: 15min
  encryption:
    key: !secret api_encryption_key

ota:
  platform: esphome
  password: !secret ota_password

switch:
  - platform: safe_mode
    name: "ESPKyoGate (Safe Mode)"

# ========================================
# Bentel KYO Hub
# ========================================

bentel_kyo:
  id: kyo
  uart_id: uart_bus

# ========================================
# Alarm Control Panel (one per partition)
# ========================================

alarm_control_panel:
  - platform: bentel_kyo
    bentel_kyo_id: kyo
    name: "Partition 1"
    partition: 1
    entry_delay:
      name: "Partition 1 Entry Delay"
    exit_delay:
      name: "Partition 1 Exit Delay"
    siren_timer:
      name: "Partition 1 Siren Timer"

  - platform: bentel_kyo
    bentel_kyo_id: kyo
    name: "Partition 2"
    partition: 2
    entry_delay:
      name: "Partition 2 Entry Delay"
    exit_delay:
      name: "Partition 2 Exit Delay"

  - platform: bentel_kyo
    bentel_kyo_id: kyo
    name: "Partition 3"
    partition: 3

  - platform: bentel_kyo
    bentel_kyo_id: kyo
    name: "Partition 4"
    partition: 4

# ========================================
# Binary Sensors
# ========================================

binary_sensor:
  - platform: bentel_kyo
    bentel_kyo_id: kyo

    # Zone status (expand up to 32 zones as needed)
    # Each zone can optionally include diagnostic text sensors:
    #   zone_type:   Sensor type read from panel (Instant/Delayed/Path)
    #   panel_name:  Zone name as configured in the panel
    #   zone_partition:   Area assignment read from panel
    #   serial_number:  Enrolled sensor serial number (wireless sensors)
    zones:
      - zone: 1
        name: "Zone 1 Sensor"
        device_class: "motion"
        zone_type:
          name: "Zone 1 Type"
        panel_name:
          name: "Zone 1 Panel Name"
        zone_partition:
          name: "Zone 1 Partition"
        serial_number:
          name: "Zone 1 Serial Number"
      - zone: 2
        name: "Zone 2 Sensor"
        device_class: "window"
        zone_type:
          name: "Zone 2 Type"
        panel_name:
          name: "Zone 2 Panel Name"
        zone_partition:
          name: "Zone 2 Partition"
        serial_number:
          name: "Zone 2 Serial Number"
      - zone: 3
        name: "Zone 3 Sensor"
        device_class: "motion"
      - zone: 4
        name: "Zone 4 Sensor"
        device_class: "window"

    # Zone tamper
    zone_tamper:
      - zone: 1
        name: "Zone 1 Tamper"
      - zone: 2
        name: "Zone 2 Tamper"
      - zone: 3
        name: "Zone 3 Tamper"
      - zone: 4
        name: "Zone 4 Tamper"

    # Zone bypass (exclusion)
    zone_bypass:
      - zone: 1
        name: "Zone 1 Bypass"
      - zone: 2
        name: "Zone 2 Bypass"
      - zone: 3
        name: "Zone 3 Bypass"
      - zone: 4
        name: "Zone 4 Bypass"

    # Zone alarm memory
    zone_alarm_memory:
      - zone: 1
        name: "Zone 1 Alarm Memory"
      - zone: 2
        name: "Zone 2 Alarm Memory"
      - zone: 3
        name: "Zone 3 Alarm Memory"
      - zone: 4
        name: "Zone 4 Alarm Memory"

    # Zone tamper memory
    zone_tamper_memory:
      - zone: 1
        name: "Zone 1 Tamper Memory"
      - zone: 2
        name: "Zone 2 Tamper Memory"
      - zone: 3
        name: "Zone 3 Tamper Memory"
      - zone: 4
        name: "Zone 4 Tamper Memory"

    # Warning flags
    warnings:
      mains_failure:
        name: "Mains Failure"
      bpi_missing:
        name: "BPI Missing"
      fuse_fault:
        name: "Fuse Fault"
      low_battery:
        name: "Low Battery"
      phone_line_fault:
        name: "Phone Line Fault"
      default_codes:
        name: "Default Codes"
      wireless_fault:
        name: "Wireless Fault"

    # Tamper flags
    tamper:
      tamper_zone:
        name: "Zone Tamper"
      tamper_false_key:
        name: "False Key Tamper"
      tamper_bpi:
        name: "BPI Tamper"
      tamper_system:
        name: "System Tamper"
      tamper_rf_jam:
        name: "RF Jam"
      tamper_wireless:
        name: "Wireless Tamper"

    # Communication status
    communication:
      name: "Panel Communication"

    # Siren status
    siren:
      name: "Siren"

    # Output states (KYO32G only â€” other models read 0xFF)
    output_state:
      - output_number: 1
        name: "Output 1"
        panel_name:
          name: "Output 1 Panel Name"
      - output_number: 2
        name: "Output 2"
        panel_name:
          name: "Output 2 Panel Name"
      - output_number: 3
        name: "Output 3"
      - output_number: 4
        name: "Output 4"

text_sensor:
  - platform: bentel_kyo
    bentel_kyo_id: kyo
    firmware_version:
      name: "Firmware Version"
    alarm_model:
      name: "Alarm Model"
    keyfobs:
      - slot: 1
        name: "Keyfob 1"
      - slot: 2
        name: "Keyfob 2"

sensor:
  - platform: uptime
    name: "Uptime"
